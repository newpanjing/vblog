---
title: 使用Django从数据库中随机取N条记录的不同方法及其性能实测
#navbar: false
sidebar: false
---

# 使用Django从数据库中随机取N条记录的不同方法及其性能实测

<p><strong>【声明】：</strong>本文中的实验仅限于特定数据库和特定框架。不同数据库，数据库服务器的性能，甚至同一个数据库的不同配置都会影响到同一段代码的性能。具体情况请在自己的生产环境进行测试。</p><p><a href="http://stackoverflow.com/questions/1731346/how-to-get-two-random-records-with-django" target="_blank" rel="noopener">这里（stackoverflow）</a>有一篇关于使用Django随机获取记录的讨论。主要意思是说</p><p>Python</p><p>&nbsp;</p><table><tbody><tr><td><p>1</p></td><td><p>Record.objects.order_by(&#39;?&#39;)[:2]</p></td></tr></tbody></table><p>这样获取2个记录会导致性能问题，原因如下：</p><p><strong>&amp;ldquo;&nbsp;</strong>对于有着相当多数量记录的表来说，这种方法异常糟糕。这会导致一个 ORDER BY RAND() 的SQL查询。举个栗子，这里是MYSQL是如何处理这个查询的（其他数据库的情况也差不多），想象一下当一个表有十亿行的时候会怎样：</p><ol class=" list-paddingleft-2"><li><p>为了完成ORDER BY RAND() ，需要一个RAND()列来排序</p></li><li><p>为了有RAND()列，需要一个新表，因为现有的表没有这个列。</p></li><li><p>为了这个新表，mysql建立了一个带有新列的，新的临时表，并且将已有的一百万行数据复制进去。</p></li><li><p>当其新建完了，他如你所要求的，为每一行运行RAND()函数来填上这个值。是的，你派mysql创建一百万个随机数，这要点时间：）</p></li><li><p>几个小时或几天后，当他干完这活，他要排序。是的，你排mysql去排序一个一百万行的，最糟糕的表（说他最糟糕是因为排序的键是随机的）。</p></li><li><p>几天或者几星期后，当排序完了，他忠诚地将你实际需要的可怜的两行抓出来返回给你。做的好。；）</p></li></ol><p>注意：只是稍微说一句，得注意到mysql一开始会试着在内存中创建临时表。当内存不够了，他将会把所有东西放在硬盘上，所以你会因为近乎于整个过程中的I/O瓶颈而雪上加霜。</p><p>怀疑者可以去看看python代码引起的查询语句，确认是ORDER BY RAND()， 然后去Google下&amp;rdquo;order by rand()&amp;rdquo;（带上引号）。</p><p>一个更好的方式是将这个耗费严重的查询换成3个耗费更轻的：</p><p>Python</p><p>&nbsp;</p><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p></td><td><p>last = MyModel.objects.count() - 1&nbsp;&nbsp;</p><p># 这是一个获取两个不重复随机数的简单方法&nbsp;&nbsp;</p><p>index1 = randint(0, last)&nbsp;&nbsp;</p><p>index2 = randint(0, last - 1)&nbsp;&nbsp;</p><p>if index2 == index1:&nbsp;&nbsp;</p><p>&nbsp;&nbsp;&nbsp;&nbsp;index2 = last&nbsp;&nbsp;</p><p>MyObj1 = MyModel.objects.all()[index1]&nbsp;&nbsp;</p><p>MyObj2 = MyModel.objects.all()[index2]</p></td></tr></tbody></table><p><strong>&amp;rdquo;</strong></p><p>如上Manganeez所说的方法，相应的获取n条记录的代码应该如下：</p><p>Python</p><p>&nbsp;</p><table><tbody><tr><td><p>1</p><p>2</p></td><td><p>sample = random.sample(xrange(Record.objects.count()),n)&nbsp;&nbsp;</p><p>result = [Record.objects.all()[i] for i in sample]</p></td></tr></tbody></table><p>基于Python代码应该简洁优雅的想法，如上的代码似乎可以写成：</p><p>Python</p><p>&nbsp;</p><table><tbody><tr><td><p>1</p></td><td><p>result = random.sample(Record.objects.all(),n)</p></td></tr></tbody></table><p>就性能问题，请教了stackoverflow上的大神 （虽然被踩和被教育了=。=）</p><p><strong>&amp;ldquo;</strong>Record.objects.count() 将被转换成一个相当轻量级的SQL请求：</p><p>MySQL</p><p>&nbsp;</p><table><tbody><tr><td><p>1</p></td><td><p>SELECT COUNT(*) FROM TABLE</p></td></tr></tbody></table><p>Record.objects.all()[0]也会被转换成一个十分轻量级的SQL请求</p><p>MySQL</p><p>&nbsp;</p><table><tbody><tr><td><p>1</p></td><td><p>SELECT * FROM TABLE LIMIT 1</p></td></tr></tbody></table><p>Querying all 是一个耗费十分严重的请求</p><p>MySQL</p><p>&nbsp;</p><table><tbody><tr><td><p>1</p></td><td><p>SELECT * FROM TABLE</p></td></tr></tbody></table><p>通常情况下Django会不显示其他的结果，这样你不会真正的获取到所有的记录。</p><p>Python</p><p>&nbsp;</p><table><tbody><tr><td><p>1</p></td><td><p>SELECT * FROM table LIMIT 20;&nbsp;&nbsp;// or something similar</p></td></tr></tbody></table><p>任何时候你将一个Queryset转换成list的时候，将是资源消耗严重的时候。</p><p>如果我没错的话，在这个例子里，sample方法将把Queryset转换成list。</p><p>这样如果你result = random.sample(Record.objects.all(),n) 这样做的话，全部的Queryset将会转换成list，然后从中随机选择。</p><p>想象一下如果你有十亿行的数据。你是打算把它存储在一个有百万元素的list中，还是愿意一个一个的query？</p><p><strong>&amp;rdquo;</strong></p><p>在上边<a href="http://stackoverflow.com/users/764592/yeo" target="_blank" rel="noopener">Yeo</a>的回答中，<a href="http://stackoverflow.com/users/645551/freakish" target="_blank" title="14148 reputation" rel="noopener">freakish</a>回复道：<strong>&amp;ldquo;</strong>.count的性能是基于数据库的。而Postgres的.count为人所熟知的相当之慢。<strong>&amp;rdquo;</strong></p><p>某人说过，要知道梨子的滋味，就得变革梨子，亲口尝一尝。</p><p>测试环境：</p><ul class=" list-paddingleft-2"><li><p>Win8.1 pro x64</p></li><li><p>Wampserver2.4-x64 (apache2.4.4 mysql5.6.12 php5.4.12)</p></li><li><p>Python2.7.5</p></li><li><p>Django1.4.6</p></li></ul><p>在一个已有的测试project中新建一个app，数据库是MYSQL：</p><p>&nbsp;</p><table><tbody><tr><td><p>1</p></td><td><p>D:\PyWorkspace\DjangoTest&gt;python manage.py startapp randomrecords</p></td></tr></tbody></table><p>在models.py中添加模型：</p><p>Python</p><p>&nbsp;</p><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p></td><td><p>class Record(models.Model):&nbsp;&nbsp;</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;docstring for Record&quot;&quot;&quot;&nbsp;&nbsp;</p><p>&nbsp;</p><p>&nbsp;&nbsp;&nbsp;&nbsp;id = models.AutoField(primary_key = True)&nbsp;&nbsp;</p><p>&nbsp;&nbsp;&nbsp;&nbsp;content = models.CharField(max_length = 16)&nbsp;&nbsp;</p><p>&nbsp;</p><p>&nbsp;&nbsp;&nbsp;&nbsp;def __str__(self):&nbsp;&nbsp;</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &quot;id:%s content:%s&quot; % (self.id, self.content)&nbsp;&nbsp;</p><p>&nbsp;&nbsp;&nbsp;&nbsp;def __unicode__(self):&nbsp;&nbsp;</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return u&quot;id:%s content:%s&quot; % (self.id, self.content)</p></td></tr></tbody></table><p>添加一万行数据：</p><p>Python</p><p>&nbsp;</p><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p></td><td><p>D:\PyWorkspace\DjangoTest&gt;python manage.py syncdb&nbsp;&nbsp;</p><p>Creating tables ...&nbsp;&nbsp;</p><p>Creating table randomrecords_record&nbsp;&nbsp;</p><p>Installing custom SQL ...&nbsp;&nbsp;</p><p>Installing indexes ...&nbsp;&nbsp;</p><p>Installed 0 object(s) from 0 fixture(s)&nbsp;&nbsp;</p><p>&nbsp;</p><p>D:\PyWorkspace\DjangoTest&gt;python manage.py shell&nbsp;&nbsp;</p><p>Python 2.7.5 (default, May 15 2013, 22:44:16) [MSC v.1500 64 bit (AMD64)] on win&nbsp;&nbsp;</p><p>32&nbsp;&nbsp;</p><p>Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.&nbsp;&nbsp;</p><p>(InteractiveConsole)&nbsp;&nbsp;</p><p>&gt;&gt;&gt; from randomrecords.models import Record&nbsp;&nbsp;</p><p>&gt;&gt;&gt; for i in xrange(10000):&nbsp;&nbsp;</p><p>...&nbsp;&nbsp; Record.objects.create(content = &#39;c of %s&#39; % i).save()</p></td></tr></tbody></table><p>15分钟以后我得到了这个MYSQL表。真的，不骗你，真的是15分钟。看了记录才知道 每次save都要调用一次insert和一次update。。。。下次一定用SQL语句初始化。。。。</p><p>先写了个脚本 在manage.py shell中调用了下 结果让我震惊了。我表示不敢相信 又写了view 并在settings.py中添加了显示SQL Query语句的log</p><p>这里是写的view：</p><p>Python</p><p>&nbsp;</p><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p></td><td><p>def test1(request):&nbsp;&nbsp;</p><p>&nbsp;&nbsp;&nbsp;&nbsp;start = datetime.datetime.now()&nbsp;&nbsp;</p><p>&nbsp;&nbsp;&nbsp;&nbsp;result = Record.objects.order_by(&#39;?&#39;)[:20]&nbsp;&nbsp;</p><p>&nbsp;&nbsp;&nbsp;&nbsp;l = list(result) # Queryset是惰性的，强制将Queryset转为list&nbsp;&nbsp;</p><p>&nbsp;&nbsp;&nbsp;&nbsp;end = datetime.datetime.now()&nbsp;&nbsp;</p><p>&nbsp;&nbsp;&nbsp;&nbsp;return HttpResponse(&quot;time: &lt;br/&gt; %s&quot; % (end-start).microseconds/1000))&nbsp;&nbsp;</p><p>&nbsp;</p><p>def test2(request):&nbsp;&nbsp;</p><p>&nbsp;&nbsp;&nbsp;&nbsp;start = datetime.datetime.now()&nbsp;&nbsp;</p><p>&nbsp;&nbsp;&nbsp;&nbsp;sample = random.sample(xrange(Record.objects.count()),20)&nbsp;&nbsp;</p><p>&nbsp;&nbsp;&nbsp;&nbsp;result = [Record.objects.all()[i] for i in sample]&nbsp;&nbsp;</p><p>&nbsp;&nbsp;&nbsp;&nbsp;l = list(result)&nbsp;&nbsp;</p><p>&nbsp;&nbsp;&nbsp;&nbsp;end = datetime.datetime.now()&nbsp;&nbsp;</p><p>&nbsp;&nbsp;&nbsp;&nbsp;return HttpResponse(&quot;time: &lt;br/&gt; %s&quot; % (end-start)&nbsp;&nbsp;</p><p>&nbsp;</p><p>def test3(request):&nbsp;&nbsp;</p><p>&nbsp;&nbsp;&nbsp;&nbsp;start = datetime.datetime.now()&nbsp;&nbsp;</p><p>&nbsp;&nbsp;&nbsp;&nbsp;result = random.sample(Record.objects.all(),20)&nbsp;&nbsp;</p><p>&nbsp;&nbsp;&nbsp;&nbsp;l = list(result)&nbsp;&nbsp;</p><p>&nbsp;&nbsp;&nbsp;&nbsp;end = datetime.datetime.now()&nbsp;&nbsp;</p><p>&nbsp;&nbsp;&nbsp;&nbsp;return HttpResponse(&quot;time: &lt;br/&gt; %s&quot; % (end-start)</p></td></tr></tbody></table><p>运行结果如下，第一行是页面显示的时间，后边是Queryset实际调用的SQL语句</p><p>&nbsp;</p><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p><p>49</p><p>50</p><p>51</p><p>52</p><p>53</p><p>54</p><p>55</p><p>56</p><p>57</p><p>58</p><p>59</p><p>60</p><p>61</p><p>62</p></td><td><p>test1：&nbsp;&nbsp;</p><p>&nbsp;</p><p>time: 0:00:00.012000&nbsp;&nbsp;</p><p>&nbsp;</p><p>(0.009) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` ORDER BY RAND() LIMIT 20; args=()&nbsp;&nbsp;</p><p>[05/Dec/2013 17:48:19] &quot;GET /dbtest/test1 HTTP/1.1&quot; 200 775&nbsp;&nbsp;</p><p>&nbsp;</p><p>test2:&nbsp;&nbsp;</p><p>&nbsp;</p><p>time: 0:00:00.055000&nbsp;&nbsp;</p><p>&nbsp;</p><p>(0.002) SELECT COUNT(*) FROM `randomrecords_record`; args=()&nbsp;&nbsp;</p><p>(0.002) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 6593; args=()&nbsp;&nbsp;</p><p>(0.001) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 2570; args=()&nbsp;&nbsp;</p><p>(0.001) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 620; args=()&nbsp;&nbsp;</p><p>(0.001) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 5814; args=()&nbsp;&nbsp;</p><p>(0.003) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 6510; args=()&nbsp;&nbsp;</p><p>(0.002) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 3536; args=()&nbsp;&nbsp;</p><p>(0.001) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 3362; args=()&nbsp;&nbsp;</p><p>(0.003) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 8948; args=()&nbsp;&nbsp;</p><p>(0.002) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 7723; args=()&nbsp;&nbsp;</p><p>(0.001) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 2374; args=()&nbsp;&nbsp;</p><p>(0.002) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 8269; args=()&nbsp;&nbsp;</p><p>(0.002) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 4370; args=()&nbsp;&nbsp;</p><p>(0.002) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 6953; args=()&nbsp;&nbsp;</p><p>(0.001) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 1441; args=()&nbsp;&nbsp;</p><p>(0.000) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 772; args=()&nbsp;&nbsp;</p><p>(0.002) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 4323; args=()&nbsp;&nbsp;</p><p>(0.002) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 8139; args=()&nbsp;&nbsp;</p><p>(0.002) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 7441; args=()&nbsp;&nbsp;</p><p>(0.001) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 1306; args=()&nbsp;&nbsp;</p><p>(0.001) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 5462; args=()&nbsp;&nbsp;</p><p>[05/Dec/2013 17:50:34] &quot;GET /dbtest/test2 HTTP/1.1&quot; 200 777&nbsp;&nbsp;</p><p>&nbsp;</p><p>test3:&nbsp;&nbsp;</p><p>&nbsp;</p><p>time: 0:00:00.156000&nbsp;&nbsp;</p><p>&nbsp;</p><p>(0.032) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record`; args=()&nbsp;&nbsp;</p><p>[05/Dec/2013 17:51:29] &quot;GET /dbtest/test3 HTTP/1.1&quot; 200 774</p></td></tr></tbody></table><p>令人难以置信的，在10000行的MYSQL表中 方法1的效率是最高的。无论是结果上看（12ms）还是SQL语句的运行时间上看（9ms）方法1甩了其他方法一大截</p><p>即便数据量增加到21万，方法1也会比其他两种方法快：</p><p>&nbsp;</p><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p><p>49</p><p>50</p><p>51</p><p>52</p><p>53</p><p>54</p><p>55</p><p>56</p></td><td><p>time: 98&nbsp;&nbsp;</p><p>&nbsp;</p><p>(0.094) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` ORDER BY RAND() LIMIT 20; args=()&nbsp;&nbsp;</p><p>[05/Dec/2013 19:18:59] &quot;GET /dbtest/test1 HTTP/1.1&quot; 200 14&nbsp;&nbsp;</p><p>&nbsp;</p><p>time: 0:00:00.668000&nbsp;&nbsp;</p><p>//这里没有注意到 掉了一行count语句&nbsp;&nbsp;</p><p>(0.045) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 176449; args=()&nbsp;&nbsp;</p><p>(0.016) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 68082; args=()&nbsp;&nbsp;</p><p>(0.036) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 145571; args=()&nbsp;&nbsp;</p><p>(0.033) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 111029; args=()&nbsp;&nbsp;</p><p>(0.043) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 169675; args=()&nbsp;&nbsp;</p><p>(0.046) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 186234; args=()&nbsp;&nbsp;</p><p>(0.043) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 167233; args=()&nbsp;&nbsp;</p><p>(0.015) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 54404; args=()&nbsp;&nbsp;</p><p>(0.036) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 140395; args=()&nbsp;&nbsp;</p><p>(0.004) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 13128; args=()&nbsp;&nbsp;</p><p>(0.039) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 153695; args=()&nbsp;&nbsp;</p><p>(0.034) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 131863; args=()&nbsp;&nbsp;</p><p>(0.021) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 82785; args=()&nbsp;&nbsp;</p><p>(0.015) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 57253; args=()&nbsp;&nbsp;</p><p>(0.021) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 77836; args=()&nbsp;&nbsp;</p><p>(0.049) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 199567; args=()&nbsp;&nbsp;</p><p>(0.002) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 3867; args=()&nbsp;&nbsp;</p><p>(0.027) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 104470; args=()&nbsp;&nbsp;</p><p>(0.026) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 107058; args=()&nbsp;&nbsp;</p><p>(0.043) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 150979; args=()&nbsp;&nbsp;</p><p>[05/Dec/2013 19:21:33] &quot;GET /dbtest/test2 HTTP/1.1&quot; 200 15&nbsp;&nbsp;</p><p>&nbsp;</p><p>time 0:00:00.781000&nbsp;&nbsp;</p><p>&nbsp;</p><p>[05/Dec/2013 19:23:01] &quot;GET /dbtest/test3 HTTP/1.1&quot; 200 15&nbsp;&nbsp;</p><p>(0.703) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record`; args=()&nbsp;&nbsp;</p><p>[05/Dec/2013 19:23:06] &quot;GET /dbtest/test3 HTTP/1.1&quot; 200 15</p></td></tr></tbody></table><p>数据量再次提升至百万级别 1066768条数据</p><p>&nbsp;</p><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p><p>49</p><p>50</p><p>51</p><p>52</p><p>53</p><p>54</p><p>55</p><p>56</p><p>57</p><p>58</p><p>59</p></td><td><p>time:&nbsp;&nbsp;</p><p>0:00:02.197000&nbsp;&nbsp;</p><p>&nbsp;</p><p>(2.193) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` ORDER BY RAND() LIMIT 20; args=()&nbsp;&nbsp;</p><p>[05/Dec/2013 20:00:55] &quot;GET /dbtest/test1 HTTP/1.1&quot; 200 26&nbsp;&nbsp;</p><p>&nbsp;</p><p>time:&nbsp;&nbsp;</p><p>0:00:02.659000&nbsp;&nbsp;</p><p>&nbsp;</p><p>(0.204) SELECT COUNT(*) FROM `randomrecords_record`; args=()&nbsp;&nbsp;</p><p>(0.180) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 703891; args=()&nbsp;&nbsp;</p><p>(0.038) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 156668; args=()&nbsp;&nbsp;</p><p>(0.013) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 50742; args=()&nbsp;&nbsp;</p><p>(0.031) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 121107; args=()&nbsp;&nbsp;</p><p>(0.033) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 130565; args=()&nbsp;&nbsp;</p><p>(0.017) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 66225; args=()&nbsp;&nbsp;</p><p>(0.234) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 922479; args=()&nbsp;&nbsp;</p><p>(0.267) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 1027166; args=()&nbsp;&nbsp;</p><p>(0.189) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 765499; args=()&nbsp;&nbsp;</p><p>(0.009) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 31569; args=()&nbsp;&nbsp;</p><p>(0.233) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 934055; args=()&nbsp;&nbsp;</p><p>(0.264) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 1052741; args=()&nbsp;&nbsp;</p><p>(0.155) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 621692; args=()&nbsp;&nbsp;</p><p>(0.014) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 52388; args=()&nbsp;&nbsp;</p><p>(0.199) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 759669; args=()&nbsp;&nbsp;</p><p>(0.170) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 655598; args=()&nbsp;&nbsp;</p><p>(0.035) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 139709; args=()&nbsp;&nbsp;</p><p>(0.228) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 919480; args=()&nbsp;&nbsp;</p><p>(0.104) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 422051; args=()&nbsp;&nbsp;</p><p>(0.017) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 67549; args=()&nbsp;&nbsp;</p><p>[05/Dec/2013 20:00:45] &quot;GET /dbtest/test2 HTTP/1.1&quot; 200 26&nbsp;&nbsp;</p><p>&nbsp;</p><p>time:&nbsp;&nbsp;</p><p>0:00:19.651000&nbsp;&nbsp;</p><p>&nbsp;</p><p>(3.645) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record`; args=()&nbsp;&nbsp;</p><p>[05/Dec/2013 20:02:50] &quot;GET /dbtest/test3 HTTP/1.1&quot; 200 26</p></td></tr></tbody></table><p>第三种方法所用时间长到令人无法接受（19.65秒）。但有意思的是 SQL语句所花费的时间&amp;ldquo;只有&amp;rdquo;3.6秒。而大部分的时间都用在python上了。</p><p>既然第二种方法和第三种方法都需要random.sample 一个百万个数据的list，那就是说，有大量的时间花费在将SELECT到的结果转化为django对象的过程中了。</p><p>此后将不再测试第三种方法</p><p>最后，数据量增加到5,195,536个</p><p>随着表中数据行数的增加，两个方法的所用的时间都到了一个完全不能接受的程度。两种方法所用的时间也几乎相同。</p><p>&nbsp;</p><p>&nbsp;</p><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p><p>49</p><p>50</p><p>51</p></td><td><p>time:&nbsp;&nbsp;</p><p>0:00:22.278000&nbsp;&nbsp;</p><p>&nbsp;</p><p>(22.275) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FR&nbsp;&nbsp;</p><p>OM `randomrecords_record` ORDER BY RAND() LIMIT 20; args=()&nbsp;&nbsp;</p><p>[05/Dec/2013 21:46:33] &quot;GET /dbtest/test1 HTTP/1.1&quot; 200 26&nbsp;&nbsp;</p><p>&nbsp;</p><p>time:&nbsp;&nbsp;</p><p>0:00:33.319000&nbsp;&nbsp;</p><p>&nbsp;</p><p>(1.393) SELECT COUNT(*) FROM `randomrecords_record`; args=()&nbsp;&nbsp;</p><p>(3.201) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 4997880; args=()&nbsp;&nbsp;</p><p>(1.229) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 2169311; args=()&nbsp;&nbsp;</p><p>(0.445) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 1745307; args=()&nbsp;&nbsp;</p><p>(1.306) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 3233861; args=()&nbsp;&nbsp;</p><p>(1.881) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 3946647; args=()&nbsp;&nbsp;</p><p>(1.624) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 3534377; args=()&nbsp;&nbsp;</p><p>(1.068) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 1684337; args=()&nbsp;&nbsp;</p><p>(0.902) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 2607361; args=()&nbsp;&nbsp;</p><p>(2.938) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 4872494; args=()&nbsp;&nbsp;</p><p>(0.493) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 851494; args=()&nbsp;&nbsp;</p><p>(3.275) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 5182414; args=()&nbsp;&nbsp;</p><p>(0.946) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 1684670; args=()&nbsp;&nbsp;</p><p>(0.701) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 1819730; args=()&nbsp;&nbsp;</p><p>(0.915) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 1626221; args=()&nbsp;&nbsp;</p><p>(1.809) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 3638682; args=()&nbsp;&nbsp;</p><p>(3.237) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 4801027; args=()&nbsp;&nbsp;</p><p>(1.187) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 1955843; args=()&nbsp;&nbsp;</p><p>(2.736) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 4835733; args=()&nbsp;&nbsp;</p><p>(1.705) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 2756641; args=()&nbsp;&nbsp;</p><p>(0.286) SELECT `randomrecords_record`.`id`, `randomrecords_record`.`content` FRO&nbsp;&nbsp;</p><p>M `randomrecords_record` LIMIT 1 OFFSET 1117426; args=()</p></td></tr></tbody></table><p>值得注意的是，Mysql数据库有一个特点是，对于一个大表，OFFSET越大，查询时间越长。或许有其他方法可以在offset较大的时候加快select的速度，然而django明显没有做到。如果能够减少这种消耗，方法2明显会优于方法1。</p><p>附上三种方法数据量和SQL时间/总时间的数据图表：</p><p><img alt="table" src="http://jbcdn2.b0.upaiyun.com/2013/12/table.jpg"/></p><p><img alt="20131205220333" src="http://jbcdn2.b0.upaiyun.com/2013/12/20131205220333.jpg"/></p><p><img alt="总时间" src="http://jbcdn2.b0.upaiyun.com/2013/12/total.jpg"/></p><p>&nbsp;</p><p>最后总结，Django下，使用mysql数据库，数据量在百万级以下时，使用</p><p>Python</p><p>&nbsp;</p><table><tbody><tr><td><p>1</p></td><td><p>Record.objects.order_by(&#39;?&#39;)[:2]</p></td></tr></tbody></table><p>来获取随机记录序列，性能不会比</p><p>Python</p><p>&nbsp;</p><table><tbody><tr><td><p>1</p><p>2</p></td><td><p>sample&nbsp;=&nbsp;random.sample(xrange(Record.objects.count()),n) &nbsp;</p><p>result&nbsp;=&nbsp;[Record.objects.all()[i])&nbsp;for&nbsp;i&nbsp;in&nbsp;sample]</p></td></tr></tbody></table><p>差。</p>


